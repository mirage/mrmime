let valid_addresses =
  [ "Mary Smith <mary@example.net>"
  ; "Mary Smith <mary@x.test>, jdoe@example.org, Who? <one@y.test>"
  ; "A Group:Ed Jones <c@a.test>,joe@where.test,John <jdoe@one.test>;"
  ; "Undisclosed recipients:;"
  ; "\"Mary Smith: Personal Account\" <smith@home.example>"
  ; "John Doe <jdoe@machine.example>"
  ; "Pete(A nice \\) chap) <pete(his account)@silly.test(his host)>"
  ; "A Group(Some people)\r\n\
    \    :Chris Jones <c@(Chris's host.)public.example>,\r\n\
    \      joe@example.org,\r\n\
    \  John <jdoe@one.test> (my dear friend); (the end of the group)"
  ; "(Empty list)(start)Hidden recipients  :(nobody(that I know))  ;"
  ; "Mary Smith <@node.test:mary@example.net>, , jdoe@test  . example"
  ; "Joe Q. Public <john.q.public@example.com>"
  ; "John Doe <jdoe@machine(comment).  example>"
  ; "Mary Smith\r\n  \r\n  <mary@example.net>"
  ; "<boss@nil.test>, \"Giant; \\\"Big\\\" Box\" <sysservices@example.net>"
  ; "!#$%&`*+/=?^`{|}~@iana.org"; "(\x07;)mary@example.net"
  ; "\"\\\x0a\"@x.test"; "\"\\a\"@x.test"; "\"\x07\"@x.test"
  ; "\"\\\x07\"@x.test"; "pete@[255.255.255.255]"; "\"mary\"@example.net"
  ; "\"\\\"\"@example.net"; "\"john\".\"public\"@example.com"
  ; "\"mary smith\"@home.example"; "\"mary\".smith@home.example"
  ; "\"mary\\\000\"@home.example"; " richard @home.example"
  ; "richar@ home .example"; "mary . smith@y.test"; "\x0d\x0a jdoe@example.net"
  ; " \x0d\x0a \x0d\x0a jdoe@example.net"; "(comment)smith@home.example"
  ; "(comment(comment))smith@home.example"; "smith@(comment)home.example"
  ; "smith@(comment)[255.255.255.255]"
  ; "robert@xn--hxajbheg2az3al.xn--jxalpdlp"; "xn--robert@x.test"
  ; "stephane+blog@bortzmeyer.org"; "{tropdur}@example.org"; "c&a@hotmail.com"
  ; "directeur@arts-premiers.museum"; "\"Stephane[Bortzmeyer]\"@laposte.net"
  ; "first.last@iana.org"
  ; "1234567890123456789012345678901234567890123456789012345678901234@iana.org"
  ; "\"first\\\"last\"@iana.org"; "\"first@last\"@iana.org"
  ; "\"first\\last\"@iana.org"; "first.last@[12.34.56.78]"
  ; "first.last@[IPv6:::12.34.56.78]"
  ; "first.last@[IPv6:1111:2222:3333::4444:12.34.56.78]"
  ; "first.last@[IPv6:1111:2222:3333:4444:5555:6666:12.34.56.78]"
  ; "first.last@[IPv6:::1111:2222:3333:4444:5555:6666]"
  ; "first.last@[IPv6:1111:2222:3333::4444:5555:6666]"
  ; "first.last@[IPv6:1111:2222:3333:4444:5555:6666::]"
  ; "first.last@[IPv6:1111:2222:3333:4444:5555:6666:7777:8888]"
  ; "first.last@x23456789012345678901234567890123456789012345678901234567890123.iana.org"
  ; "first.last@3com.com"; "first.last@123.iana.org"
  ; "first.last@[IPv6:1111:2222:3333::4444:5555:12.34.56.78]"
  ; "first.last@[IPv6:1111:2222:3333::4444:5555:6666:7777]"
  ; "first.last@example.123"; "first.last@com"; "\"Abc\\@def\"@iana.org"
  ; "\"Fred\\ Bloggs\"@iana.org"; "\"Joe.\\Blow\"@iana.org"
  ; "\"Abc@def\"@iana.org"; "\"Fred Bloggs\"@iana.org"; "user+mailbox@iana.org"
  ; "customer/department=shipping@iana.org"; "$A12345@iana.org"
  ; "!def!xyz%abc@iana.org"; "_somename@iana.org"; "dclo@us.ibm.com"
  ; "peter.piper@iana.org"; "\"Doug \\\"Ace\\\" L.\"@iana.org"; "test@iana.org"
  ; "TEST@iana.org"; "1234567890@iana.org"; "test+test@iana.org"
  ; "test-test@iana.org"; "t*est@iana.org"; "+1~1+@iana.org"
  ; "{_test_}@iana.org"; "\"[[ test  ]]\"@iana.org"; "test.test@iana.org"
  ; "\"test.test\"@iana.org"; "test.\"test\"@iana.org"
  ; "\"test@test\"@iana.org"; "test@123.123.123.x123"; "test@123.123.123.123"
  ; "test@[123.123.123.123]"; "test@example.iana.org"
  ; "test@example.example.iana.org"; "\"test\\test\"@iana.org"; "test@example"
  ; "\"test\\blah\"@iana.org"; "\"test\\\"blah\"@iana.org"
  ; "customer/department@iana.org"; "_Yosemite.Sam@iana.org"; "~@iana.org"
  ; "\"Austin@Powers\"@iana.org"; "Ima.Fool@iana.org"; "\"Ima.Fool\"@iana.org"
  ; "\"Ima Fool\"@iana.org"; "\"first\".\"last\"@iana.org"
  ; "\"first\".middle.\"last\"@iana.org"; "\"first\".last@iana.org"
  ; "first.\"last\"@iana.org"; "\"first\".\"middle\".\"last\"@iana.org"
  ; "\"first.middle\".\"last\"@iana.org"; "\"first.middle.last\"@iana.org"
  ; "\"first..last\"@iana.org"; "\"first\\\\\\\"last\"@iana.org"
  ; "first.\"mid\\dle\".\"last\"@iana.org"; "\"test blah\"@iana.org"
  ; "(foo)cal(bar)@(baz)iamcal.com(quux)"; "cal@iamcal(woo).(yay)com"
  ; "cal(woo(yay)hoopla)@iamcal.com"; "cal(foo\\@bar)@iamcal.com"
  ; "cal(foo\\)bar)@iamcal.com"; "first().last@iana.org"
  ; "pete(his account)@silly.test(his host)"; "c@(Chris's host.)public.example"
  ; "jdoe@machine(comment). example"; "1234 @ local(blah) .machine .example"
  ; "first(abc.def).last@iana.org"; "first(a\"bc.def).last@iana.org"
  ; "first.(\")middle.last(\")@iana.org"; "first(abc\\(def)@iana.org"
  ; "first.last@x(1234567890123456789012345678901234567890123456789012345678901234567890).com"
  ; "a(a(b(c)d(e(f))g)h(i)j)@iana.org"; "name.lastname@domain.com"; "a@b"
  ; "a@bar.com"; "aaa@[123.123.123.123]"; "a@bar"; "a-b@bar.com"; "+@b.c"
  ; "+@b.com"; "a@b.co-foo.uk"; "\"hello my name is\"@stutter.com"
  ; "\"Test \\\"Fail\\\" Ing\"@iana.org"; "valid@about.museum"
  ; "shaitan@my-domain.thisisminekthx"; "foobar@192.168.0.1"
  ; "\"Joe\\Blow\"@iana.org"
  ; "HM2Kinsists@(that comments are allowed)this.is.ok"
  ; "user%uucp!path@berkeley.edu"; "first.last @iana.org"
  ; "cdburgess+!#$%&'*-/=?+_{}|~test@gmail.com"
  ; "first.last@[IPv6:a1:a2:a3:a4:b1:b2:b3::]"; "first.last@[IPv6:::]"
  ; "first.last@[IPv6:::b4]"; "first.last@[IPv6:::b3:b4]"
  ; "first.last@[IPv6:a1::b4]"; "first.last@[IPv6:a1::]"
  ; "first.last@[IPv6:a1:a2::]"; "first.last@[IPv6:0123:4567:89ab:cdef::]"
  ; "first.last@[IPv6:0123:4567:89ab:CDEF::]"
  ; "first.last@[IPv6:::a3:a4:b1:ffff:11.22.33.44]"
  ; "first.last@[IPv6:a1:a2:a3:a4::11.22.33.44]"
  ; "first.last@[IPv6:a1:a2:a3:a4:b1::11.22.33.44]"
  ; "first.last@[IPv6:a1::11.22.33.44]"; "first.last@[IPv6:a1:a2::11.22.33.44]"
  ; "first.last@[IPv6:0123:4567:89ab:cdef::11.22.33.44]"
  ; "first.last@[IPv6:0123:4567:89ab:CDEF::11.22.33.44]"
  ; "first.last@[IPv6:a1::b2:11.22.33.44]"
  ; "first.last@[IPv6:::a2:a3:a4:b1:b2:b3:b4]"
  ; "first.last@[IPv6:::a2:a3:a4:b1:ffff:11.22.33.44]"; "test@test.com"
  ; "test@xn--example.com"; "test@example.com" ]

let invalid_addresses =
  [ ""; "mary"; "@"; "mary@"; "@io"; "@example.net"; ".mary@example.net"
  ; "jdoe.@example.net"; "pete..silly.test"; "sm_i-th.com"
  ; "mary\\@jdoe@one.test"; "jdoe@.one.test"; "jdon@one.test."
  ; "boss@nil..test"; "\"\"\"@example.net"; "\"\\\"@example.net"
  ; "jdoe\"@machine.example"; "\"jdoe@machine.example"
  ; "\"john\"public@example.com"; "john\"public\"@example.com"
  ; "\"john\"\"public\"@example.com"; "\"mary\000\"@home.example"
  ; "pete@a[255.255.255.255]"; "((comment)smith@home.example"
  ; "smith(coment)doe@home.example"; "robert@henry.com\r"
  ; "(smith@home.example"; "robert@[1.2.3.4"; "\"john\\\"@example.com"
  ; "(comment\\)smith@home.example"; "smith@home.example(comment\\)"
  ; "smith@home.example(comment\\"; "robert@[RFC5322-[domain-literal\\]"
  ; "robert@[RFC5322-[domain-literal]"; "robert@[RFC5322-[domain-literal\\"
  ; "marx@capitalism.ru\x0d"; "\x0dmarx@capitalism.ru"
  ; "\"\x0dmarx\"@capitalism.ru"; "(\x0d)marx@capitalism.ru"
  ; "marx@capitalism.ru(\x0d)"; "smith@communism.uk\x0a"
  ; "\x0asmith@communism.uk"; "\"\x0asmith\"@communism.uk"
  ; "(\x0a)smith@communism.uk"; "smith@communism.uk(\x0a)"
  ; "first.last@sub.do,com"; "first\\@last@iana.org"; "first.last"
  ; ".first.last@iana.org"; "first.last.@iana.org"; "first..last@iana.org"
  ; "\"first\"last\"@iana.org"; "\"\"\"@iana.org"; "\"\\\"@iana.org"
  ; "\"\"@iana.org"; "first\\@last@iana.org"; "first.last@"
  ; "first.last@[.12.34.56.78]"; "first.last@[12.34.56.789]"
  ; "first.last@[::12.34.56.78]"; "first.last@[IPv5:::12.34.56.78]"
  ; "first.last@[IPv6:1111:2222:3333:4444:5555:12.34.56.78]"
  ; "first.last@[IPv6:1111:2222:3333:4444:5555:6666:7777:12.34.56.78]"
  ; "first.last@[IPv6:1111:2222:3333:4444:5555:6666:7777]"
  ; "first.last@[IPv6:1111:2222:3333:4444:5555:6666:7777:8888:9999]"
  ; "first.last@[IPv6:1111:2222::3333::4444:5555:6666]"
  ; "first.last@[IPv6:1111:2222:333x::4444:5555]"
  ; "first.last@[IPv6:1111:2222:33333::4444:5555]"; "abc\\@def@iana.org"
  ; "abc\\@iana.org"; "@iana.org"; "doug@"; "\"qu@iana.org"; "ote\"@iana.org"
  ; ".dot@iana.org"; "dot.@iana.org"; "two..dot@iana.org"
  ; "\"Doug \"Ace\" L.\"@iana.org"; "Doug\\ \\\"Ace\\\"\\ L\\.@iana.org"
  ; "hello world@iana.org"; "gatsby@f.sc.ot.t.f.i.tzg.era.l.d."
  ; "test.iana.org"; "test.@iana.org"; "test..test@iana.org"; ".test@iana.org"
  ; "test@test@iana.org"; "test@@iana.org"; "-- test --@iana.org"
  ; "[test]@iana.org"; "\"test\"test\"@iana.org"; "()[]\\;:,><@iana.org"
  ; "test@."; "test@example."; "test@.org"; "test@[123.123.123.123"
  ; "test@123.123.123.123]"; "NotAnEmail"; "NotAnEmail"
  ; "\"test\"blah\"@iana.org"; ".wooly@iana.org"; "wo..oly@iana.org"
  ; "pootietang.@iana.org"; ".@iana.org"; "Ima Fool@iana.org"
  ; "phil.h\\@\\@ck@haacked.com"; "first\\last@iana.org"; "Abc\\@def@iana.org"
  ; "Fred\\ Bloggs@iana.org"; "Joe.\\Blow@iana.org"
  ; "first.last@[IPv6:1111:2222:3333:4444:5555:6666:12.34.567.89]"
  ; "{^c\\@**Dog^}@cartoon.com"; "cal(foo(bar)@iamcal.com"
  ; "cal(foo\\)@iamcal.com"; "cal(foo)bar)@iamcal.com"
  ; "first(middle)last@iana.org"; "a(a(b(c)d(e(f))g)(h(i)j)@iana.org"; ".@"
  ; "@bar.com"; "@@bar.com"; "aaa.com"; "aaa@.com"; "aaa@.com"; "aaa@.123"
  ; "aaa@[123.123.123.123]a"; "aaa@[123.123.123.333]"; "a@bar.com."; "-@..com"
  ; "-@a..com"; "test@...........com"; "\"\000 \"@char.com"; "\000@char.com"
  ; "first.last@[IPv6::]"; "first.last@[IPv6::::]"; "first.last@[IPv6::b4]"
  ; "first.last@[IPv6::::b4]"; "first.last@[IPv6::b3:b4]"
  ; "first.last@[IPv6::::b3:b4]"; "first.last@[IPv6:a1:::b4]"
  ; "first.last@[IPv6:a1:]"; "first.last@[IPv6:a1:::]"
  ; "first.last@[IPv6:a1:a2:]"; "first.last@[IPv6:a1:a2:::]"
  ; "first.last@[IPv6::11.22.33.44]"; "first.last@[IPv6::::11.22.33.44]"
  ; "first.last@[IPv6:a1:11.22.33.44]"; "first.last@[IPv6:a1:::11.22.33.44]"
  ; "first.last@[IPv6:a1:a2:::11.22.33.44]"
  ; "first.last@[IPv6:0123:4567:89ab:cdef::11.22.33.xx]"
  ; "first.last@[IPv6:0123:4567:89ab:CDEFF::11.22.33.44]"
  ; "first.last@[IPv6:a1::a4:b1::b4:11.22.33.44]"
  ; "first.last@[IPv6:a1::11.22.33]"; "first.last@[IPv6:a1::11.22.33.44.55]"
  ; "first.last@[IPv6:a1::b211.22.33.44]"; "first.last@[IPv6:a1::11.22.33]"
  ; "first.last@[IPv6:a1::11.22.33.44.55]"
  ; "first.last@[IPv6:a1::b211.22.33.44]"
  ; "first.last@[IPv6:a1::b2::11.22.33.44]"; "first.last@[IPv6:a1::b3:]"
  ; "first.last@[IPv6::a2::b4]"; "first.last@[IPv6:a1:a2:a3:a4:b1:b2:b3:]"
  ; "first.last@[IPv6::a2:a3:a4:b1:b2:b3:b4]"
  ; "first.last@[IPv6:a1:a2:a3:a4::b1:b2:b3:b4]"
  ; "=?us-ascii?Q?Chri's_Smith?= =?us-ascii?Q?Henry?= \
     <.@gmail.com,@hotmail.fr:henry.chris+porno@(Chris's \
     host.)public.example> (je suis un connard en puissance)"
  ; "jdoe@[RFC-5322-\\a-domain-literal]"; "jdoe@[RFC-5322-\\t-domain-literal]"
  ; "jdoe@[RFC-5322-\\]-domain-literal]"
  ; "jdoe@[RFC-5322-domain-literal] (comment)" ]

exception Invalid_address

let parse_address x =
  let x = x ^ "\r\n" in
  match
    Angstrom.(parse_string Mrmime.(Rfc5322.address_list <* Rfc822.crlf) x)
  with
  | Ok _ -> ()
  | Error _ -> raise Invalid_address

let valid_tests =
  List.map
    (fun input ->
      Alcotest.test_case input `Quick
      @@ fun () -> Alcotest.(check pass) input (parse_address input) () )
    valid_addresses

let invalid_tests =
  List.map
    (fun input ->
      Alcotest.test_case input `Quick
      @@ fun () ->
      Alcotest.check_raises input Invalid_address (fun () ->
          parse_address input ) )
    invalid_addresses

let () =
  Alcotest.run "rfc5322" [("valid", valid_tests); ("invalid", invalid_tests)]
